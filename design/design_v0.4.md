# é¡¹ç›®ç®¡ç†ç³»ç»Ÿå¢é‡è®¾è®¡ v0.4

## æ–°å¢åŠŸèƒ½ï¼šå¤šæ•°æ®åº“åˆ‡æ¢

### åŠŸèƒ½æ¦‚è¿°
åœ¨ v0.3 å¿«é€Ÿæ·»åŠ åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œæ–°å¢æ•°æ®åº“åˆ‡æ¢åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨å¤šä¸ªå·¥ä½œç©ºé—´ï¼ˆæ•°æ®åº“æ–‡ä»¶ï¼‰ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œé€‚ç”¨äºç®¡ç†ä¸åŒå›¢é˜Ÿã€é¡¹ç›®æˆ–æ—¶é—´æ®µçš„ä»»åŠ¡ã€‚

### ä½¿ç”¨åœºæ™¯
- **å¤šå›¢é˜Ÿç®¡ç†**: ä¸åŒå›¢é˜Ÿä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œé¿å…æ•°æ®æ··æ·†
- **ä¸ªäºº/å·¥ä½œåˆ†ç¦»**: ä¸ªäººäº‹é¡¹å’Œå·¥ä½œäº‹é¡¹åˆ†å¼€ç®¡ç†
- **é¡¹ç›®å½’æ¡£**: å†å²é¡¹ç›®ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“å½’æ¡£ï¼Œä¸»æ•°æ®åº“ä¿æŒæ¸…çˆ½
- **æµ‹è¯•ç¯å¢ƒ**: å¼€å‘/æµ‹è¯•æ•°æ®åº“ä¸ç”Ÿäº§æ•°æ®åº“åˆ†ç¦»

---

## UI è®¾è®¡

### å¯¼èˆªæ å¸ƒå±€è°ƒæ•´

```
[é¡¹ç›®ç®¡ç†ç³»ç»Ÿ] [ğŸ—„ï¸ åˆ‡æ¢æ•°æ®åº“] [+ å¿«é€Ÿæ·»åŠ ]  |  [åˆ†ç±»ç®¡ç†] [æ¯å‘¨è§†å›¾] [å‘¨æŠ¥ç”Ÿæˆ]
```

**å¸ƒå±€è¯´æ˜**:
- åœ¨ã€Œé¡¹ç›®ç®¡ç†ç³»ç»Ÿã€æ ‡é¢˜å³ä¾§æ·»åŠ ã€ŒğŸ—„ï¸ åˆ‡æ¢æ•°æ®åº“ã€æŒ‰é’®
- ã€Œåˆ‡æ¢æ•°æ®åº“ã€æŒ‰é’®ä½äºã€Œå¿«é€Ÿæ·»åŠ ã€å·¦ä¾§
- é¡ºåºï¼šLogo/æ ‡é¢˜ â†’ æ•°æ®åº“åˆ‡æ¢ â†’ å¿«é€Ÿæ·»åŠ  â†’ åŠŸèƒ½å¯¼èˆª

**æŒ‰é’®æ ·å¼**:
- å›¾æ ‡ï¼šä½¿ç”¨æ–‡ä»¶å¤¹æˆ–æ•°æ®åº“å›¾æ ‡ï¼ˆğŸ—„ï¸ æˆ– ğŸ“ï¼‰
- é¢œè‰²ï¼šåŒºåˆ«äºã€Œå¿«é€Ÿæ·»åŠ ã€æŒ‰é’®ï¼Œä½¿ç”¨æ¬¡è¦è‰²ï¼ˆå¦‚ç°è‰²/ç´«è‰²ï¼‰
- æ˜¾ç¤ºå½“å‰æ•°æ®åº“åç§°ï¼ˆå¯é€‰ï¼Œç©ºé—´å…è®¸æ—¶ï¼‰
- æ‚¬åœæç¤ºï¼šæ˜¾ç¤ºå½“å‰æ•°æ®åº“çš„å®Œæ•´ä¿¡æ¯

---

## æ•°æ®åº“åˆ‡æ¢æ¨¡æ€æ¡†è®¾è®¡

### æ¨¡æ€æ¡†æ ‡é¢˜
**åˆ‡æ¢æ•°æ®åº“**

### ä¸»è¦åŒºåŸŸ

#### 1. å½“å‰æ•°æ®åº“ä¿¡æ¯
```
å½“å‰æ•°æ®åº“ï¼šwork-main.db
åˆ›å»ºæ—¶é—´ï¼š2024-11-20
æœ€åä½¿ç”¨ï¼š2024-11-24 14:30
ç»Ÿè®¡ï¼š5ä¸ªåˆ†ç±» | 12ä¸ªé¡¹ç›® | 48ä¸ªäº‹é¡¹
```

#### 2. æ•°æ®åº“åˆ—è¡¨
- ä»¥å¡ç‰‡å½¢å¼å±•ç¤ºæ‰€æœ‰å¯ç”¨æ•°æ®åº“
- æ¯ä¸ªæ•°æ®åº“å¡ç‰‡åŒ…å«ï¼š
  - æ•°æ®åº“åç§°ï¼ˆå¯ç‚¹å‡»ç¼–è¾‘ï¼‰
  - æ–‡ä»¶è·¯å¾„ï¼ˆç®€åŒ–æ˜¾ç¤ºï¼‰
  - åŸºæœ¬ç»Ÿè®¡ï¼ˆåˆ†ç±»æ•°ã€é¡¹ç›®æ•°ã€äº‹é¡¹æ•°ï¼‰
  - åˆ›å»ºæ—¶é—´
  - æœ€åä½¿ç”¨æ—¶é—´
  - æ“ä½œæŒ‰é’®ï¼š
    - **åˆ‡æ¢** - åˆ‡æ¢åˆ°è¯¥æ•°æ®åº“
    - **é‡å‘½å** - ä¿®æ”¹æ˜¾ç¤ºåç§°
    - **åˆ é™¤** - åˆ é™¤æ•°æ®åº“æ–‡ä»¶ï¼ˆéœ€äºŒæ¬¡ç¡®è®¤ï¼‰

#### 3. æ–°å»ºæ•°æ®åº“åŒºåŸŸ
```
[+ æ–°å»ºæ•°æ®åº“]

è¾“å…¥æ¡†ï¼š
- æ•°æ®åº“åç§°ï¼šwork-new
- æè¿°ï¼ˆå¯é€‰ï¼‰ï¼šæ–°é¡¹ç›®å·¥ä½œç©ºé—´

[åˆ›å»º]  [å–æ¶ˆ]
```

---

## æŠ€æœ¯å®ç°

### åç«¯å®ç°

#### 1. æ•°æ®åº“é…ç½®ç®¡ç†

##### é…ç½®æ–‡ä»¶ç»“æ„ (`db-config.json`)
```json
{
  "currentDb": "work-main.db",
  "databases": {
    "work-main.db": {
      "displayName": "ä¸»å·¥ä½œç©ºé—´",
      "description": "æ—¥å¸¸å·¥ä½œä»»åŠ¡ç®¡ç†",
      "filePath": "data/work-main.db",
      "createdAt": "2024-11-20T10:00:00Z",
      "lastUsed": "2024-11-24T14:30:00Z"
    },
    "personal.db": {
      "displayName": "ä¸ªäººäº‹é¡¹",
      "description": "ä¸ªäººå­¦ä¹ å’Œç”Ÿæ´»è§„åˆ’",
      "filePath": "data/personal.db",
      "createdAt": "2024-11-22T09:00:00Z",
      "lastUsed": "2024-11-23T20:15:00Z"
    }
  }
}
```

#### 2. ä¿®æ”¹ `database.js`

```javascript
const initSqlJs = require('sql.js');
const fs = require('fs');
const path = require('path');

// é…ç½®æ–‡ä»¶è·¯å¾„
const CONFIG_PATH = path.join(__dirname, 'db-config.json');
const DATA_DIR = path.join(__dirname, 'data');

let db = null;
let currentDbPath = null;
let dbConfig = null;

// ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
if (!fs.existsSync(DATA_DIR)) {
  fs.mkdirSync(DATA_DIR);
}

// åŠ è½½æ•°æ®åº“é…ç½®
function loadConfig() {
  if (fs.existsSync(CONFIG_PATH)) {
    const content = fs.readFileSync(CONFIG_PATH, 'utf-8');
    dbConfig = JSON.parse(content);
  } else {
    // åˆå§‹åŒ–é»˜è®¤é…ç½®
    dbConfig = {
      currentDb: 'work-main.db',
      databases: {
        'work-main.db': {
          displayName: 'ä¸»å·¥ä½œç©ºé—´',
          description: 'æ—¥å¸¸å·¥ä½œä»»åŠ¡ç®¡ç†',
          filePath: path.join(DATA_DIR, 'work-main.db'),
          createdAt: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        }
      }
    };
    saveConfig();
  }
  return dbConfig;
}

// ä¿å­˜æ•°æ®åº“é…ç½®
function saveConfig() {
  fs.writeFileSync(CONFIG_PATH, JSON.stringify(dbConfig, null, 2));
}

// è·å–å½“å‰æ•°æ®åº“è·¯å¾„
function getCurrentDbPath() {
  if (!dbConfig) loadConfig();
  const currentDbName = dbConfig.currentDb;
  return dbConfig.databases[currentDbName]?.filePath || 
         path.join(DATA_DIR, currentDbName);
}

// åˆ‡æ¢æ•°æ®åº“
async function switchDatabase(dbName) {
  if (!dbConfig.databases[dbName]) {
    throw new Error(`Database ${dbName} not found in config`);
  }
  
  // ä¿å­˜å½“å‰æ•°æ®åº“
  if (db) {
    saveDatabase();
  }
  
  // æ›´æ–°é…ç½®
  dbConfig.currentDb = dbName;
  dbConfig.databases[dbName].lastUsed = new Date().toISOString();
  saveConfig();
  
  // åŠ è½½æ–°æ•°æ®åº“
  await setupDatabase();
  
  return {
    success: true,
    currentDb: dbName,
    info: dbConfig.databases[dbName]
  };
}

// åˆ›å»ºæ–°æ•°æ®åº“
async function createDatabase(dbName, displayName, description = '') {
  if (dbConfig.databases[dbName]) {
    throw new Error(`Database ${dbName} already exists`);
  }
  
  const filePath = path.join(DATA_DIR, dbName);
  
  // æ·»åŠ åˆ°é…ç½®
  dbConfig.databases[dbName] = {
    displayName: displayName || dbName,
    description,
    filePath,
    createdAt: new Date().toISOString(),
    lastUsed: new Date().toISOString()
  };
  saveConfig();
  
  // åˆ‡æ¢åˆ°æ–°æ•°æ®åº“å¹¶åˆå§‹åŒ–
  await switchDatabase(dbName);
  initDatabase();
  initDefaultData();
  
  return {
    success: true,
    dbName,
    info: dbConfig.databases[dbName]
  };
}

// åˆ é™¤æ•°æ®åº“
function deleteDatabase(dbName) {
  if (dbName === dbConfig.currentDb) {
    throw new Error('Cannot delete current database');
  }
  
  if (!dbConfig.databases[dbName]) {
    throw new Error(`Database ${dbName} not found`);
  }
  
  const filePath = dbConfig.databases[dbName].filePath;
  
  // åˆ é™¤æ–‡ä»¶
  if (fs.existsSync(filePath)) {
    fs.unlinkSync(filePath);
  }
  
  // ä»é…ç½®ä¸­ç§»é™¤
  delete dbConfig.databases[dbName];
  saveConfig();
  
  return { success: true };
}

// é‡å‘½åæ•°æ®åº“
function renameDatabase(dbName, newDisplayName, newDescription) {
  if (!dbConfig.databases[dbName]) {
    throw new Error(`Database ${dbName} not found`);
  }
  
  dbConfig.databases[dbName].displayName = newDisplayName;
  if (newDescription !== undefined) {
    dbConfig.databases[dbName].description = newDescription;
  }
  saveConfig();
  
  return {
    success: true,
    info: dbConfig.databases[dbName]
  };
}

// è·å–æ‰€æœ‰æ•°æ®åº“ä¿¡æ¯ï¼ˆåŒ…å«ç»Ÿè®¡ï¼‰
async function getAllDatabases() {
  const databases = [];
  
  for (const [dbName, info] of Object.entries(dbConfig.databases)) {
    let stats = { categories: 0, projects: 0, tasks: 0 };
    
    // å¦‚æœæ˜¯å½“å‰æ•°æ®åº“ï¼Œç›´æ¥æŸ¥è¯¢
    if (dbName === dbConfig.currentDb && db) {
      const result = query(`
        SELECT 
          (SELECT COUNT(*) FROM categories) as categories,
          (SELECT COUNT(*) FROM projects) as projects,
          (SELECT COUNT(*) FROM tasks) as tasks
      `);
      if (result.length > 0) {
        stats = result[0];
      }
    } else {
      // å…¶ä»–æ•°æ®åº“éœ€è¦ä¸´æ—¶åŠ è½½æ¥è·å–ç»Ÿè®¡
      try {
        const SQL = await initSqlJs();
        if (fs.existsSync(info.filePath)) {
          const buffer = fs.readFileSync(info.filePath);
          const tempDb = new SQL.Database(buffer);
          
          const result = tempDb.exec(`
            SELECT 
              (SELECT COUNT(*) FROM categories) as categories,
              (SELECT COUNT(*) FROM projects) as projects,
              (SELECT COUNT(*) FROM tasks) as tasks
          `);
          
          if (result.length > 0 && result[0].values.length > 0) {
            stats = {
              categories: result[0].values[0][0],
              projects: result[0].values[0][1],
              tasks: result[0].values[0][2]
            };
          }
          
          tempDb.close();
        }
      } catch (e) {
        console.error(`Error reading stats for ${dbName}:`, e);
      }
    }
    
    databases.push({
      name: dbName,
      displayName: info.displayName,
      description: info.description,
      filePath: info.filePath,
      createdAt: info.createdAt,
      lastUsed: info.lastUsed,
      isCurrent: dbName === dbConfig.currentDb,
      stats
    });
  }
  
  // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
  databases.sort((a, b) => 
    new Date(b.lastUsed) - new Date(a.lastUsed)
  );
  
  return databases;
}

// ä¿®æ”¹åŸæœ‰çš„ setupDatabase
async function setupDatabase() {
  loadConfig();
  currentDbPath = getCurrentDbPath();
  
  const SQL = await initSqlJs();
  
  // å°è¯•åŠ è½½å·²æœ‰æ•°æ®åº“
  if (fs.existsSync(currentDbPath)) {
    const buffer = fs.readFileSync(currentDbPath);
    db = new SQL.Database(buffer);
  } else {
    db = new SQL.Database();
  }
  
  return db;
}

// ä¿®æ”¹åŸæœ‰çš„ saveDatabase
function saveDatabase() {
  if (db && currentDbPath) {
    const data = db.export();
    const buffer = Buffer.from(data);
    fs.writeFileSync(currentDbPath, buffer);
  }
}

// å¯¼å‡ºæ–°å¢çš„å‡½æ•°
module.exports = {
  setupDatabase,
  saveDatabase,
  initDatabase,
  initDefaultData,
  query,
  run,
  get,
  getDb: () => db,
  
  // æ–°å¢çš„æ•°æ®åº“ç®¡ç†å‡½æ•°
  switchDatabase,
  createDatabase,
  deleteDatabase,
  renameDatabase,
  getAllDatabases,
  getCurrentDbInfo: () => ({
    name: dbConfig?.currentDb,
    ...dbConfig?.databases[dbConfig?.currentDb]
  })
};
```

#### 3. æ–°å¢ API æ¥å£ (`server.js`)

```javascript
// ============ æ•°æ®åº“ç®¡ç† API ============

// è·å–æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
app.get('/api/databases', async (req, res) => {
  try {
    const databases = await getAllDatabases();
    res.json(databases);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});

// è·å–å½“å‰æ•°æ®åº“ä¿¡æ¯
app.get('/api/databases/current', (req, res) => {
  try {
    const info = getCurrentDbInfo();
    res.json(info);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});

// åˆ‡æ¢æ•°æ®åº“
app.post('/api/databases/switch', async (req, res) => {
  try {
    const { dbName } = req.body;
    if (!dbName) {
      return res.status(400).json({ error: 'Database name is required' });
    }
    
    const result = await switchDatabase(dbName);
    res.json(result);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});

// åˆ›å»ºæ–°æ•°æ®åº“
app.post('/api/databases', async (req, res) => {
  try {
    const { dbName, displayName, description } = req.body;
    
    if (!dbName) {
      return res.status(400).json({ error: 'Database name is required' });
    }
    
    // éªŒè¯æ–‡ä»¶åæ ¼å¼
    if (!/^[a-zA-Z0-9_-]+\.db$/.test(dbName)) {
      return res.status(400).json({ 
        error: 'Invalid database name. Use format: name.db' 
      });
    }
    
    const result = await createDatabase(dbName, displayName, description);
    res.json(result);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});

// é‡å‘½åæ•°æ®åº“
app.put('/api/databases/:dbName', (req, res) => {
  try {
    const { dbName } = req.params;
    const { displayName, description } = req.body;
    
    const result = renameDatabase(dbName, displayName, description);
    res.json(result);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});

// åˆ é™¤æ•°æ®åº“
app.delete('/api/databases/:dbName', (req, res) => {
  try {
    const { dbName } = req.params;
    const result = deleteDatabase(dbName);
    res.json(result);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

---

## å‰ç«¯å®ç°

### 1. å¯¼èˆªæ æ·»åŠ æ•°æ®åº“åˆ‡æ¢æŒ‰é’® (`index.html`)

```html
<nav class="top-nav">
    <div class="nav-left">
        <h1>é¡¹ç›®ç®¡ç†ç³»ç»Ÿ</h1>
        <button class="btn-db-switch" onclick="app.showDatabaseModal()">
            <span class="db-icon">ğŸ—„ï¸</span>
            <span id="currentDbName">ä¸»å·¥ä½œç©ºé—´</span>
        </button>
        <button class="btn-quick-add" onclick="app.showQuickAddModal()">
            <span class="plus-icon">+</span>
            <span>å¿«é€Ÿæ·»åŠ </span>
        </button>
    </div>
    <div class="nav-buttons">
        <button class="nav-btn active" data-view="categories">åˆ†ç±»ç®¡ç†</button>
        <button class="nav-btn" data-view="weekly">æ¯å‘¨è§†å›¾</button>
        <button class="nav-btn" data-view="report">å‘¨æŠ¥ç”Ÿæˆ</button>
    </div>
</nav>
```

### 2. æ•°æ®åº“åˆ‡æ¢æ¨¡æ€æ¡† (`index.html`)

```html
<!-- æ•°æ®åº“åˆ‡æ¢æ¨¡æ€æ¡† -->
<div id="databaseModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>åˆ‡æ¢æ•°æ®åº“</h3>
            <span class="close" onclick="app.closeDatabaseModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- å½“å‰æ•°æ®åº“ä¿¡æ¯ -->
            <div class="current-db-info" id="currentDbInfo">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- æ•°æ®åº“åˆ—è¡¨ -->
            <div class="db-list-header">
                <h4>æ‰€æœ‰æ•°æ®åº“</h4>
                <button class="btn btn-primary btn-sm" onclick="app.showCreateDbForm()">
                    + æ–°å»ºæ•°æ®åº“
                </button>
            </div>
            
            <div class="database-list" id="databaseList">
                <!-- åŠ¨æ€åŠ è½½æ•°æ®åº“å¡ç‰‡ -->
            </div>
            
            <!-- æ–°å»ºæ•°æ®åº“è¡¨å•ï¼ˆåˆå§‹éšè—ï¼‰-->
            <div class="create-db-form" id="createDbForm" style="display:none;">
                <h4>æ–°å»ºæ•°æ®åº“</h4>
                <div class="form-group">
                    <label>æ•°æ®åº“æ–‡ä»¶å *</label>
                    <input type="text" id="newDbName" placeholder="ä¾‹å¦‚: personal.db" />
                    <small>åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œå¿…é¡»ä»¥ .db ç»“å°¾</small>
                </div>
                <div class="form-group">
                    <label>æ˜¾ç¤ºåç§° *</label>
                    <input type="text" id="newDbDisplayName" placeholder="ä¾‹å¦‚: ä¸ªäººäº‹é¡¹" />
                </div>
                <div class="form-group">
                    <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="newDbDescription" rows="2" placeholder="ç®€å•æè¿°è¿™ä¸ªæ•°æ®åº“çš„ç”¨é€”"></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="app.hideCreateDbForm()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="app.createDatabase()">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 3. JavaScript å®ç° (`app.js`)

```javascript
const app = {
    // ... ç°æœ‰ä»£ç  ...
    
    currentDbName: null,
    
    // åˆå§‹åŒ–æ—¶åŠ è½½å½“å‰æ•°æ®åº“ä¿¡æ¯
    async init() {
        this.setupNavigation();
        await this.loadCurrentDatabase();
        this.loadCategories();
        this.currentWeek = this.getCurrentWeekNumber();
        this.setupWeekOptions();
    },
    
    // åŠ è½½å½“å‰æ•°æ®åº“ä¿¡æ¯
    async loadCurrentDatabase() {
        try {
            const response = await fetch(`${API_BASE}/databases/current`);
            const dbInfo = await response.json();
            this.currentDbName = dbInfo.name;
            document.getElementById('currentDbName').textContent = 
                dbInfo.displayName || dbInfo.name;
        } catch (error) {
            console.error('åŠ è½½æ•°æ®åº“ä¿¡æ¯å¤±è´¥:', error);
        }
    },
    
    // ============ æ•°æ®åº“ç®¡ç† ============
    
    async showDatabaseModal() {
        const modal = document.getElementById('databaseModal');
        await this.loadDatabaseList();
        modal.classList.add('active');
    },
    
    closeDatabaseModal() {
        document.getElementById('databaseModal').classList.remove('active');
        this.hideCreateDbForm();
    },
    
    async loadDatabaseList() {
        try {
            const response = await fetch(`${API_BASE}/databases`);
            const databases = await response.json();
            
            this.renderCurrentDbInfo(databases.find(db => db.isCurrent));
            this.renderDatabaseList(databases);
        } catch (error) {
            console.error('åŠ è½½æ•°æ®åº“åˆ—è¡¨å¤±è´¥:', error);
            alert('åŠ è½½æ•°æ®åº“åˆ—è¡¨å¤±è´¥');
        }
    },
    
    renderCurrentDbInfo(currentDb) {
        const container = document.getElementById('currentDbInfo');
        if (!currentDb) {
            container.innerHTML = '<p>æ— æ³•è·å–å½“å‰æ•°æ®åº“ä¿¡æ¯</p>';
            return;
        }
        
        container.innerHTML = `
            <div class="current-db-card">
                <div class="db-card-header">
                    <h4>${currentDb.displayName}</h4>
                    <span class="current-badge">å½“å‰</span>
                </div>
                <p class="db-description">${currentDb.description || 'æš‚æ— æè¿°'}</p>
                <div class="db-stats">
                    <span>${currentDb.stats.categories} ä¸ªåˆ†ç±»</span>
                    <span>${currentDb.stats.projects} ä¸ªé¡¹ç›®</span>
                    <span>${currentDb.stats.tasks} ä¸ªäº‹é¡¹</span>
                </div>
                <div class="db-meta">
                    <small>åˆ›å»ºæ—¶é—´: ${new Date(currentDb.createdAt).toLocaleString('zh-CN')}</small>
                    <small>æœ€åä½¿ç”¨: ${new Date(currentDb.lastUsed).toLocaleString('zh-CN')}</small>
                </div>
            </div>
        `;
    },
    
    renderDatabaseList(databases) {
        const container = document.getElementById('databaseList');
        
        if (databases.length === 0) {
            container.innerHTML = '<p class="empty-message">æš‚æ— å…¶ä»–æ•°æ®åº“</p>';
            return;
        }
        
        container.innerHTML = databases.map(db => `
            <div class="db-card ${db.isCurrent ? 'current' : ''}">
                <div class="db-card-header">
                    <div>
                        <h5>${db.displayName}</h5>
                        <small class="db-filename">${db.name}</small>
                    </div>
                    ${db.isCurrent ? '<span class="current-badge">å½“å‰</span>' : ''}
                </div>
                
                <p class="db-description">${db.description || 'æš‚æ— æè¿°'}</p>
                
                <div class="db-stats">
                    <span>ğŸ“ ${db.stats.categories} åˆ†ç±»</span>
                    <span>ğŸ“Š ${db.stats.projects} é¡¹ç›®</span>
                    <span>âœ… ${db.stats.tasks} äº‹é¡¹</span>
                </div>
                
                <div class="db-meta">
                    <small>æœ€åä½¿ç”¨: ${this.formatRelativeTime(db.lastUsed)}</small>
                </div>
                
                <div class="db-actions">
                    ${!db.isCurrent ? `
                        <button class="btn btn-primary btn-sm" 
                                onclick="app.switchDatabase('${db.name}')">
                            åˆ‡æ¢
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary btn-sm" 
                            onclick="app.renameDatabase('${db.name}')">
                        é‡å‘½å
                    </button>
                    ${!db.isCurrent ? `
                        <button class="btn btn-danger btn-sm" 
                                onclick="app.deleteDatabase('${db.name}')">
                            åˆ é™¤
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    },
    
    formatRelativeTime(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'åˆšåˆš';
        if (diffMins < 60) return `${diffMins} åˆ†é’Ÿå‰`;
        if (diffHours < 24) return `${diffHours} å°æ—¶å‰`;
        if (diffDays < 7) return `${diffDays} å¤©å‰`;
        
        return date.toLocaleDateString('zh-CN');
    },
    
    async switchDatabase(dbName) {
        if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°æ•°æ®åº“ "${dbName}" å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/databases/switch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dbName })
            });
            
            if (response.ok) {
                this.showToast('æ•°æ®åº“åˆ‡æ¢æˆåŠŸï¼', 'success');
                this.closeDatabaseModal();
                
                // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ–°æ•°æ®åº“çš„æ•°æ®
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                const error = await response.json();
                alert('åˆ‡æ¢å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ‡æ¢æ•°æ®åº“å¤±è´¥:', error);
            alert('åˆ‡æ¢å¤±è´¥');
        }
    },
    
    showCreateDbForm() {
        document.getElementById('createDbForm').style.display = 'block';
        document.getElementById('newDbName').focus();
    },
    
    hideCreateDbForm() {
        document.getElementById('createDbForm').style.display = 'none';
        document.getElementById('newDbName').value = '';
        document.getElementById('newDbDisplayName').value = '';
        document.getElementById('newDbDescription').value = '';
    },
    
    async createDatabase() {
        const dbName = document.getElementById('newDbName').value.trim();
        const displayName = document.getElementById('newDbDisplayName').value.trim();
        const description = document.getElementById('newDbDescription').value.trim();
        
        // éªŒè¯
        if (!dbName) {
            alert('è¯·è¾“å…¥æ•°æ®åº“æ–‡ä»¶å');
            return;
        }
        
        if (!/^[a-zA-Z0-9_-]+\.db$/.test(dbName)) {
            alert('æ–‡ä»¶åæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ ¼å¼: name.db\nåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
            return;
        }
        
        if (!displayName) {
            alert('è¯·è¾“å…¥æ˜¾ç¤ºåç§°');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/databases`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dbName, displayName, description })
            });
            
            if (response.ok) {
                this.showToast('æ•°æ®åº“åˆ›å»ºæˆåŠŸï¼', 'success');
                this.hideCreateDbForm();
                
                // åˆ·æ–°é¡µé¢ä»¥åŠ è½½æ–°æ•°æ®åº“
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                const error = await response.json();
                alert('åˆ›å»ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ›å»ºæ•°æ®åº“å¤±è´¥:', error);
            alert('åˆ›å»ºå¤±è´¥');
        }
    },
    
    async renameDatabase(dbName) {
        const newDisplayName = prompt('è¯·è¾“å…¥æ–°çš„æ˜¾ç¤ºåç§°:');
        if (!newDisplayName || !newDisplayName.trim()) {
            return;
        }
        
        const newDescription = prompt('è¯·è¾“å…¥æ–°çš„æè¿°ï¼ˆå¯é€‰ï¼‰:');
        
        try {
            const response = await fetch(`${API_BASE}/databases/${dbName}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    displayName: newDisplayName.trim(), 
                    description: newDescription?.trim() 
                })
            });
            
            if (response.ok) {
                this.showToast('é‡å‘½åæˆåŠŸï¼', 'success');
                await this.loadDatabaseList();
                
                // å¦‚æœé‡å‘½åçš„æ˜¯å½“å‰æ•°æ®åº“ï¼Œæ›´æ–°å¯¼èˆªæ æ˜¾ç¤º
                if (dbName === this.currentDbName) {
                    await this.loadCurrentDatabase();
                }
            } else {
                const error = await response.json();
                alert('é‡å‘½åå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('é‡å‘½åå¤±è´¥:', error);
            alert('é‡å‘½åå¤±è´¥');
        }
    },
    
    async deleteDatabase(dbName) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ•°æ®åº“ "${dbName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }
        
        // äºŒæ¬¡ç¡®è®¤
        const confirmText = prompt('è¯·è¾“å…¥æ•°æ®åº“æ–‡ä»¶åä»¥ç¡®è®¤åˆ é™¤:');
        if (confirmText !== dbName) {
            alert('æ–‡ä»¶åä¸åŒ¹é…ï¼Œå–æ¶ˆåˆ é™¤');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/databases/${dbName}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.showToast('æ•°æ®åº“å·²åˆ é™¤', 'success');
                await this.loadDatabaseList();
            } else {
                const error = await response.json();
                alert('åˆ é™¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥');
        }
    }
};
```

### 4. CSS æ ·å¼ (`style.css`)

```css
/* æ•°æ®åº“åˆ‡æ¢æŒ‰é’® */
.btn-db-switch {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: #5a67d8;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-db-switch:hover {
    background-color: #4c51bf;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-db-switch .db-icon {
    font-size: 1.125rem;
}

/* å½“å‰æ•°æ®åº“ä¿¡æ¯å¡ç‰‡ */
.current-db-info {
    margin-bottom: 1.5rem;
}

.current-db-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.current-db-card .db-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.current-db-card h4 {
    margin: 0;
    font-size: 1.25rem;
}

.current-badge {
    background-color: rgba(255,255,255,0.3);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.current-db-card .db-description {
    margin: 0.5rem 0 1rem 0;
    opacity: 0.9;
}

.current-db-card .db-stats {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.current-db-card .db-stats span {
    font-size: 0.9375rem;
    font-weight: 500;
}

.current-db-card .db-meta {
    display: flex;
    gap: 1.5rem;
    opacity: 0.8;
    font-size: 0.8125rem;
}

/* æ•°æ®åº“åˆ—è¡¨ */
.db-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.db-list-header h4 {
    margin: 0;
}

.database-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.db-card {
    background-color: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.2s;
}

.db-card:hover {
    border-color: #cbd5e0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.db-card.current {
    border-color: #667eea;
    background-color: #f7fafc;
}

.db-card .db-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
}

.db-card h5 {
    margin: 0 0 0.25rem 0;
    font-size: 1.125rem;
    color: #2d3748;
}

.db-card .db-filename {
    color: #718096;
    font-size: 0.75rem;
}

.db-card .current-badge {
    background-color: #667eea;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.625rem;
    font-weight: 600;
}

.db-card .db-description {
    color: #4a5568;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.db-card .db-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
    font-size: 0.8125rem;
    color: #718096;
}

.db-card .db-meta {
    margin-bottom: 1rem;
    font-size: 0.75rem;
    color: #a0aec0;
}

.db-card .db-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* æ–°å»ºæ•°æ®åº“è¡¨å• */
.create-db-form {
    background-color: #f7fafc;
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.create-db-form h4 {
    margin: 0 0 1rem 0;
    color: #2d3748;
}

.create-db-form .form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #718096;
    font-size: 0.75rem;
}

.create-db-form .form-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1rem;
}

/* æŒ‰é’®å°ºå¯¸å˜ä½“ */
.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
}

/* ç©ºçŠ¶æ€æ¶ˆæ¯ */
.empty-message {
    text-align: center;
    color: #a0aec0;
    padding: 2rem;
    font-style: italic;
}
```

---

## å®‰å…¨è€ƒè™‘

### 1. æ•°æ®å¤‡ä»½
- åˆ‡æ¢æ•°æ®åº“å‰è‡ªåŠ¨ä¿å­˜å½“å‰æ•°æ®åº“
- å»ºè®®å®šæœŸå¤‡ä»½æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
- å¯è€ƒè™‘æ·»åŠ è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½

### 2. æ–‡ä»¶éªŒè¯
- ä¸¥æ ¼éªŒè¯æ•°æ®åº“æ–‡ä»¶åæ ¼å¼
- é˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼ˆ/../ï¼‰
- é™åˆ¶æ–‡ä»¶å¤§å°å’Œæ•°é‡

### 3. åˆ é™¤ç¡®è®¤
- ä¸¤æ¬¡ç¡®è®¤æœºåˆ¶
- ä¸å…è®¸åˆ é™¤å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“
- æä¾›æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆæœªæ¥æ‰©å±•ï¼‰

---

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. æ™ºèƒ½æç¤º
- æ˜¾ç¤ºæ¯ä¸ªæ•°æ®åº“çš„ç»Ÿè®¡ä¿¡æ¯
- æ˜¾ç¤ºæœ€åä½¿ç”¨æ—¶é—´
- å½“å‰æ•°æ®åº“é«˜äº®æ˜¾ç¤º

### 2. å¿«é€Ÿåˆ‡æ¢
- æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
- æ”¯æŒæœç´¢/ç­›é€‰ï¼ˆæœªæ¥æ‰©å±•ï¼‰
- æä¾›æœ€è¿‘ä½¿ç”¨åˆ—è¡¨ï¼ˆæœªæ¥æ‰©å±•ï¼‰

### 3. é”™è¯¯å¤„ç†
- æ•°æ®åº“æ–‡ä»¶æŸåæ—¶çš„å‹å¥½æç¤º
- åˆ‡æ¢å¤±è´¥æ—¶çš„å›æ»šæœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

---

## æœªæ¥æ‰©å±•

### 1. æ•°æ®å¯¼å…¥å¯¼å‡º
- å¯¼å‡ºæ•°æ®åº“ä¸º JSON
- ä» JSON å¯¼å…¥æ•°æ®
- æ•°æ®åº“åˆå¹¶åŠŸèƒ½

### 2. äº‘åŒæ­¥
- æ”¯æŒåŒæ­¥åˆ°äº‘å­˜å‚¨
- å¤šè®¾å¤‡æ•°æ®åŒæ­¥
- å†²çªè§£å†³æœºåˆ¶

### 3. æ•°æ®åº“æ¨¡æ¿
- é¢„è®¾æ•°æ®åº“æ¨¡æ¿
- å¿«é€Ÿåˆ›å»ºç‰¹å®šç±»å‹çš„å·¥ä½œç©ºé—´

### 4. æƒé™ç®¡ç†
- æ•°æ®åº“çº§åˆ«çš„è®¿é—®æ§åˆ¶
- åªè¯»æ¨¡å¼
- å¯†ç ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰

---

## å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
- âœ… å¤šæ•°æ®åº“æ–‡ä»¶æ”¯æŒ
- âœ… æ•°æ®åº“åˆ‡æ¢
- âœ… åˆ›å»ºæ–°æ•°æ®åº“
- âœ… é‡å‘½åæ•°æ®åº“
- âœ… åˆ é™¤æ•°æ®åº“

### Phase 2: ä½“éªŒä¼˜åŒ–ï¼ˆä¸‹ä¸€ç‰ˆæœ¬ï¼‰
- æœç´¢å’Œç­›é€‰
- æ•°æ®åº“å¤‡ä»½åŠŸèƒ½
- æœ€è¿‘ä½¿ç”¨å¿«é€Ÿè®¿é—®
- æ•°æ®ç»Ÿè®¡è¯¦æƒ…

### Phase 3: é«˜çº§åŠŸèƒ½ï¼ˆæœªæ¥ï¼‰
- æ•°æ®å¯¼å…¥å¯¼å‡º
- äº‘åŒæ­¥
- æ•°æ®åº“æ¨¡æ¿
- æƒé™ç®¡ç†
